---
title: Realyで見るNext.jsとSSGの未来
tags: Next.js RelayModern GraphQL
author: wawoon
image: https://wawoon.dev/next-relay.png
published_at: 2020-07-03
---
export const config = { amp: true }

現在自分が取り組んでいるプロジェクトでは、Next.jsとRelay Modernを採用して開発を進めています。
[Relay](https://relay.dev/)はFacebookが開発しているGraphQLクライアントライブラリです。
Next.jsの9.3で導入されたgetStaticProps, および9.4で導入されたIncremental Static Regenerationは、Relayと非常に相性がいい、ということを説明します。

# Example

公式のexampleがすでにあるので見てください。
https://github.com/vercel/next.js/tree/canary/examples/with-relay-modern

自分がNext.js + Relay Modern + SSGで実装を始めたときには以下のexampleがなかったので苦労していました。
（記事公開後に自分のバージョンも公開するかもしれません）

# なぜこの選定がよいのか？

## Next.jsとSSG

[Incremental Static Regeneration で実現する次世代のサーバーアーキテクチャ
](https://mizchi.dev/202005182044-awesome-next-issg)にあるように、Next.js 9.4では[Incremental Static Regeneration](https://nextjs.org/blog/next-9-4#incremental-static-regeneration-beta)が実装されています。

getStaticPropsで返す値に`unstable_revalidate`フィールドを追加すると、Next.jsのデプロイ後に定期的に特定ページをSSGし直し、静的ページを配信できるようになります。
これにより、ある程度動的なコンテンツであっても、ほぼの最新状態をSSG化し配信することが可能になります。

よくある記事メディアや、ログイン機能がないようなサービスはSSG化することで、lighthouseの点数を上げることができます。
また、Incremental Static Regenerationにより、ampを生成することももちろん可能です（一部バグ([1](https://github.com/vercel/next.js/issues/14251),[2](https://github.com/vercel/next.js/issues/14256))がありますが回避可能です。)

## SSGとGraphQL

SSGとGraphQLは非常に相性がいいです。（GatsbyはGraphQLでクエリしたデータをベースにSSGしています）
GraphQLの欠点の一つは1つのクエリに対して複数のフィールドがクエリされるため、最も遅いフィールドがボトルネックになることですが、Incremental Static Regenerationによりこの欠点は解消されます。

## GraphQLライブラリの中でもRelayを使うべき理由

上記の利点はNext.jsと[Apollo](https://github.com/apollographql/apollo-client)を採用しても同じ結果を得られますが、個人的にはRelayをおすすめします。

### はじめから全部入りであること

Relayはbuilt-inでrelay-compilerというgraphqlクエリを事前にcompileしてAST化するツールが入っています。
これにはtypescriptプラグインがあり、これをいれるとレスポンスの値は常に型がついた状態になります。

Apolloの場合でも[graphql-code-generator](https://graphql-code-generator.com/)というツールをつかっても同じことができますが、relayはすべて公式で提供されているので設定が楽です。

### Fragmentの利用が快適であること

Relayは[fragment](https://vivit.hatenablog.com/entry/2020/05/22/193021)をはじめから使いやすくするための仕組みが入っています。
デフォルトで`src`以下にあるコンポーネントを[createFragmentContainer](https://relay.dev/docs/en/fragment-container)でラップすると、他のクエリでfragmentを使えるようになります。
また、`fragment`でラップされている側のコンポーネントでは、`fragment`内で指定されているフィールド以外は見ることができず、安全であり、もちろんTypeScriptの型も自動で生成されます。

（apolloの場合は[graphql-anywhere](https://github.com/doomsower/graphql-anywhere)でフィルタする必要があります。）

自分の観測では、Apolloユーザーの方たちは`fragment`を活用するのに苦労している人たちが多い印象です。fragment使いたい人はRelayをおすすめします。

### Next.jsで使うGraphQLライブラリはNodeで実行されるのであまり変わらない

Next.js/SSGを念頭に置くと、[useQuery](https://www.apollographql.com/docs/react/api/react-hooks/#usequery)やQueryコンポーネントなどの機能は使わなくなります(relayにも[hooksサポートはあります](https://github.com/relay-tools/relay-hooks))。
というのも、`getStaticProps`や、`getServerSideProps`はnodeで実行され、返り値のみがReactの世界に送出されます。
したがってhooksなどを利用するのはクライアント側のみで実行結果を得たいときのみになります。

なお、`getStaticProps`をつかってSSGされているページは、クライアント遷移時には`getStaticProps`の戻り値がjsonとしてクライアント側に送られます。
これは`next/link`のprefetchにおいても同様で、ページ内にリンクが表示された瞬間にjsonを事前ダウンロードされ、遷移時はネットワークリクエストなしで遷移できるので非常に速いです。

# GraphQLに関する相談をしたい人はこちら

もしNext.jsでRelayをつかうかも、と思われる方がいれば以下のSlackに入ってもらえると、自分も質問対応できるのでおすすめです。

[GraphQLを使っている人たちの集まり](https://join.slack.com/t/graphql-users-jp/shared_invite/zt-96j4zua9-qNgD2ADHDJ3SojAq2ldpZA)

執筆時点で175名の方がいます。各ライブラリごとにchannelを切っているので、ライブラリ固有の相談などもできます。

# まとめ

- Next.jsのIncremental Static Regenerationは、GraphQLと相性がいいです
- Apolloじゃなくて、Relayもいいぞ
- [GraphQLを使っている人たちの集まり](https://join.slack.com/t/graphql-users-jp/shared_invite/zt-96j4zua9-qNgD2ADHDJ3SojAq2ldpZA)参加者募集中です
